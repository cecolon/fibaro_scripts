{"name":"Vifte","type":"virtual_device","properties":{"deviceIcon":244,"currentIcon":"245","log":"","logTemp":"","mainLoop":"","ui.lblSpeed.value":"2","ui.lblState.value":"counting","ui.lblTimeLeft.value":"1227","ui.sldTimeTimeout.value":30,"visible":"true","rows":[{"type":"slider","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Timeout (min)","name":"sldTimeTimeout","msg":"String to send","buttonIcon":0,"value":30,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":2,"lua":true,"waitForResponse":false,"caption":"Off","name":"btnValue1","empty":false,"msg":"local thisId = fibaro:getSelfId();\n\nfibaro:call(thisId, \"setProperty\", \"ui.lblTimeLeft.value\", \"0\");\n","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"2","name":"btnValue2","empty":false,"msg":"local thisId = fibaro:getSelfId();\n\nlocal setSpeed = tonumber(fibaro:getValue(thisId, \"ui.lblSpeed.value\"));\n\nif setSpeed < 3 then\n  fibaro:call(thisId, \"setProperty\", \"ui.lblSpeed.value\", \"2\");\nend\n\nfibaro:call(thisId, \"setProperty\", \"ui.lblState.value\", \"starting\");\n","buttonIcon":0,"favourite":false,"main":false},{"id":4,"lua":true,"waitForResponse":false,"caption":"3","name":"btnValue3","empty":false,"msg":"local thisId = fibaro:getSelfId();\n\nlocal setSpeed = tonumber(fibaro:getValue(thisId, \"ui.lblSpeed.value\"));\n\nfibaro:call(thisId, \"setProperty\", \"ui.lblSpeed.value\", \"3\");\n\nfibaro:call(thisId, \"setProperty\", \"ui.lblState.value\", \"starting\");\n","buttonIcon":0,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"Toggle","name":"btnToggle","empty":false,"msg":"local thisId = fibaro:getSelfId();\n\nlocal setSpeed = tonumber(fibaro:getValue(thisId, \"ui.lblSpeed.value\"));\n\nif setSpeed == 1 then\n  fibaro:call(thisId, \"setProperty\", \"ui.lblSpeed.value\", \"3\");\n  fibaro:call(thisId, \"setProperty\", \"ui.sldTimeTimeout.value\", \"30\");\n  fibaro:call(thisId, \"setProperty\", \"ui.lblState.value\", \"starting\");\nelse\n  fibaro:call(thisId, \"setProperty\", \"ui.lblTimeLeft.value\", \"0\");\nend\n","buttonIcon":0,"favourite":false,"main":true}]},{"type":"label","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"Speed","name":"lblSpeed","favourite":false,"main":false}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"State","name":"lblState","favourite":false,"main":false}]},{"type":"label","elements":[{"id":8,"lua":false,"waitForResponse":false,"caption":"Time left","name":"lblTimeLeft","favourite":false,"main":true}]},{"type":"button","elements":[{"id":9,"lua":true,"waitForResponse":false,"caption":"Tick","name":"btnTick","empty":false,"msg":"local secs_per_iteration = 3;\nlocal fanId_1 = 252;\nlocal fanId_2 = 254;\n\nlocal thisId = fibaro:getSelfId();\nlocal timeTimeout = 60*tonumber(fibaro:getValue(thisId, \"ui.sldTimeTimeout.value\"));\nlocal setSpeed = tonumber(fibaro:getValue(thisId, \"ui.lblSpeed.value\"));\nlocal counter = tonumber(fibaro:getValue(thisId, \"ui.lblTimeLeft.value\"));\nlocal state = fibaro:getValue(thisId, \"ui.lblState.value\");\n\nfibaro:debug(\"state = \" .. state .. \", counter = \" .. counter);\n\nif state == \"starting\" then\n  \n  if counter < timeTimeout then\n\t  counter = timeTimeout; -- Reset counter\n  end\n  \n  state = \"counting\";\n  fibaro:debug(\"State transition to \" .. state);\n  \nelseif state == \"counting\" then\n    \n  counter = counter - secs_per_iteration; -- Decrement counter\n  \n  if counter <= 0 then\n    state = \"timeout\";\n    fibaro:debug(\"State transition to \" .. state);\n  end\n  \nelseif state == \"timeout\" then\n  \n  fibaro:call(thisId, \"setProperty\", \"ui.lblSpeed.value\", \"1\");\n      \n  state = \"idle\";\n  fibaro:debug(\"State transition to \" .. state);\n\nend  \n\nfibaro:call(thisId, \"setProperty\", \"ui.lblTimeLeft.value\", counter); -- Update counter\nfibaro:call(thisId, \"setProperty\", \"ui.lblState.value\", state); -- Update state\n\nif setSpeed == 1 then\n  fibaro:call(fanId_1, \"turnOn\");\n  fibaro:call(fanId_2, \"turnOff\");\n  fibaro:call(thisId, \"setProperty\", \"currentIcon\", 244);\nelseif setSpeed == 2 then\n  fibaro:call(fanId_1, \"turnOff\");\n  fibaro:call(fanId_2, \"turnOn\");\n  fibaro:call(thisId, \"setProperty\", \"currentIcon\", 245);\nelseif setSpeed == 3 then\n  fibaro:call(fanId_1, \"turnOn\");\n  fibaro:call(fanId_2, \"turnOn\");\n  fibaro:call(thisId, \"setProperty\", \"currentIcon\", 246);\nend","buttonIcon":244,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}